# Arquivo: docker-compose.yml

services:
  # --- 1. INFRAESTRUTURA: CLUSTER CONSUL ---
  consul-1:
    image: hashicorp/consul:latest
    hostname: consul-1
    ports: ["8500:8500"]
    command: >
      agent -server -ui -node=consul-node-1 -bootstrap-expect=3 -client=0.0.0.0
      -retry-join=consul-2 -retry-join=consul-3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 5s
      timeout: 2s
      retries: 10
    profiles: [infra]

  consul-2:
    image: hashicorp/consul:latest
    hostname: consul-2
    command: >
      agent -server -node=consul-node-2 -bootstrap-expect=3 -client=0.0.0.0
      -retry-join=consul-1 -retry-join=consul-3
    depends_on: [consul-1]
    profiles: [infra]

  consul-3:
    image: hashicorp/consul:latest
    hostname: consul-3
    command: >
      agent -server -node=consul-node-3 -bootstrap-expect=3 -client=0.0.0.0
      -retry-join=consul-1 -retry-join=consul-2
    depends_on: [consul-1]
    profiles: [infra]

  # --- 2. APLICAÇÃO: SERVIÇOS ESCALÁVEIS ---
  jokenpo-session:
    build:
      context: .
      dockerfile: ./cmd/server/session/Dockerfile
    depends_on:
      consul-1:
        condition: service_healthy
    environment:
      - CONSUL_HTTP_ADDR=consul-1:8500,consul-2:8500,consul-3:8500
      - SESSION_SERVICE_PORT=8080
      - HEALTH_CHECK_PORT=8080
    deploy:
      replicas: 2
    profiles: [game]

  shop-service:
    build:
      context: .
      dockerfile: ./cmd/server/shop/Dockerfile
    depends_on:
      consul-1:
        condition: service_healthy
    environment:
      - CONSUL_HTTP_ADDR=consul-1:8500,consul-2:8500,consul-3:8500
      - SHOP_SERVICE_PORT=8081
      - HEALTH_CHECK_PORT=8081
    deploy:
      replicas: 2
    profiles: [game]

  jokenpo-queue:
    build:
      context: .
      dockerfile: ./cmd/server/queue/Dockerfile
    depends_on:
      consul-1:
        condition: service_healthy
    environment:
      - CONSUL_HTTP_ADDR=consul-1:8500,consul-2:8500,consul-3:8500
      - QUEUE_SERVICE_PORT=8082
      - HEALTH_CHECK_PORT=8082
    deploy:
      replicas: 2
    profiles: [game]

  # --- NOVO SERVIÇO ADICIONADO ---
  jokenpo-gameroom:
    build:
      context: .
      dockerfile: ./cmd/server/gameroom/Dockerfile # Aponta para o novo Dockerfile
    depends_on:
      consul-1:
        condition: service_healthy
    environment:
      - CONSUL_HTTP_ADDR=consul-1:8500,consul-2:8500,consul-3:8500
      - GAMEROOM_SERVICE_PORT=8083 # Usa a porta definida no main.go
      - HEALTH_CHECK_PORT=8083
    deploy:
      # Este serviço não tem eleição de líder, então podemos escalá-lo
      # para distribuir a carga de criação de salas.
      replicas: 3
    profiles: [game]

  # --- 3. CAMADA DE ENTRADA: LOAD BALANCERS ---
  load-balancer-1:
    build:
      context: .
      dockerfile: ./cmd/server/loadbalancer/Dockerfile
    ports: ["9080:80"]
    depends_on:
      consul-1:
        condition: service_healthy
    environment:
      - CONSUL_HTTP_ADDR=consul-1:8500,consul-2:8500,consul-3:8500
      - LB_TARGET_SERVICE=jokenpo-session
      - LB_LISTEN_ADDR=:80
    profiles: [lb]

  load-balancer-2:
    build:
      context: .
      dockerfile: ./cmd/server/loadbalancer/Dockerfile
    ports: ["9181:80"] # Porta externa corrigida
    depends_on:
      consul-1:
        condition: service_healthy
    environment:
      - CONSUL_HTTP_ADDR=consul-1:8500,consul-2:8500,consul-3:8500
      - LB_TARGET_SERVICE=jokenpo-session
      - LB_LISTEN_ADDR=:80
    profiles: [lb]

  load-balancer-3:
    build:
      context: .
      dockerfile: ./cmd/server/loadbalancer/Dockerfile
    ports: ["9282:80"] # Porta externa corrigida
    depends_on:
      consul-1:
        condition: service_healthy
    environment:
      - CONSUL_HTTP_ADDR=consul-1:8500,consul-2:8500,consul-3:8500
      - LB_TARGET_SERVICE=jokenpo-session
      - LB_LISTEN_ADDR=:80
    profiles: [lb]