
services:
  # --- 1. INFRAESTRUTURA: CLUSTER CONSUL ---
  consul-1:
    image: hashicorp/consul:latest
    hostname: consul-1
    ports:
      - "8500:8500"
    command: >
      agent -server -ui -node=consul-node-1 -bootstrap-expect=3 -client=0.0.0.0
      -retry-join=consul-2 -retry-join=consul-3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 5s
      timeout: 2s
      retries: 10

  consul-2:
    image: hashicorp/consul:latest
    hostname: consul-2
    command: >
      agent -server -node=consul-node-2 -bootstrap-expect=3 -client=0.0.0.0
      -retry-join=consul-1 -retry-join=consul-3
    depends_on:
      - consul-1

  consul-3:
    image: hashicorp/consul:latest
    hostname: consul-3
    command: >
      agent -server -node=consul-node-3 -bootstrap-expect=3 -client=0.0.0.0
      -retry-join=consul-1 -retry-join=consul-2
    depends_on:
      - consul-1

  # --- 2. APLICAÇÃO: SERVIDORES DE JOGO ---
  jokenpo-monolith-1:
    build:
      context: .
      dockerfile: ./cmd/server/Dockerfile
    hostname: jokenpo-monolith-1
    depends_on:
      consul-1: { condition: service_healthy }
    environment:
      - HEALTH_CHECK_PORT=8000
      - CONSUL_HTTP_ADDR=consul-1:8500

  jokenpo-monolith-2:
    build:
      context: .
      dockerfile: ./cmd/server/Dockerfile
    hostname: jokenpo-monolith-2
    depends_on:
      consul-1: { condition: service_healthy }
    environment:
      - HEALTH_CHECK_PORT=8001
      - CONSUL_HTTP_ADDR=consul-1:8500

  # --- 3. CAMADA DE ENTRADA: LOAD BALANCERS ---
  load-balancer-1:
    build:
      context: .
      dockerfile: ./services/loadbalancer/cmd/Dockerfile
    hostname: load-balancer-1
    ports:
      - "9080:80"
    depends_on:
      consul-1: { condition: service_healthy }
    environment:
      - CONSUL_ADDRS=consul-1:8500,consul-2:8500,consul-3:8500
      - LB_TARGET_SERVICE=jokenpo-monolith

  load-balancer-2:
    build:
      context: .
      dockerfile: ./services/loadbalancer/cmd/Dockerfile
    hostname: load-balancer-2
    ports:
      - "9081:80"
    depends_on:
      consul-1: { condition: service_healthy }
    environment:
      - CONSUL_ADDRS=consul-1:8500,consul-2:8500,consul-3:8500
      - LB_TARGET_SERVICE=jokenpo-monolith


# docker compose -f docker-compose.scale.yml --profile "*" up --build --scale load-balancer=3 --scale jokenpo-monolith=10