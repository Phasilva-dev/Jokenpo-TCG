# Arquivo: docker-compose.scale.yml

services:
  # --- 1. INFRAESTRUTURA: CLUSTER CONSUL ---
  # Nenhuma mudança aqui.
  consul-1:
    image: hashicorp/consul:latest
    hostname: consul-1
    ports: ["8500:8500"]
    command: >
      agent -server -ui -node=consul-node-1 -bootstrap-expect=3 -client=0.0.0.0
      -retry-join=consul-2 -retry-join=consul-3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 5s
      timeout: 2s
      retries: 10
    profiles: [infra]

  consul-2:
    image: hashicorp/consul:latest
    hostname: consul-2
    command: >
      agent -server -node=consul-node-2 -bootstrap-expect=3 -client=0.0.0.0
      -retry-join=consul-1 -retry-join=consul-3
    depends_on: [consul-1]
    profiles: [infra]

  consul-3:
    image: hashicorp/consul:latest
    hostname: consul-3
    command: >
      agent -server -node=consul-node-3 -bootstrap-expect=3 -client=0.0.0.0
      -retry-join=consul-1 -retry-join=consul-2
    depends_on: [consul-1]
    profiles: [infra]

  # --- 2. APLICAÇÃO: SERVIÇOS ESCALÁVEIS ---
  jokenpo-session:
    build:
      context: .
      dockerfile: ./cmd/server/session/Dockerfile
    # --- MUDANÇA: A diretiva 'hostname' foi removida. ---
    # O código Go agora usa os.Hostname(), que pegará o nome único gerado pelo Docker Compose.
    depends_on:
      consul-1:
        condition: service_healthy
    # --- MUDANÇA: Variáveis de ambiente explícitas para o serviço ---
    environment:
      - CONSUL_HTTP_ADDR=consul-1:8500
      - SESSION_SERVICE_PORT=8080
      - HEALTH_CHECK_PORT=8080
    deploy:
      replicas: 3
    profiles: [game]

  shop-service:
    build:
      context: .
      dockerfile: ./cmd/server/shop/Dockerfile
    # --- MUDANÇA: A diretiva 'hostname' foi removida. ---
    depends_on:
      consul-1:
        condition: service_healthy
    # --- MUDANÇA: Variáveis de ambiente explícitas para o serviço ---
    environment:
      - CONSUL_HTTP_ADDR=consul-1:8500
      - SHOP_SERVICE_PORT=8081
      - HEALTH_CHECK_PORT=8081
    deploy:
      replicas: 3
    profiles: [game]

  # --- 3. CAMADA DE ENTRADA: LOAD BALANCERS ---
  load-balancer-1:
    build:
      context: .
      dockerfile: ./cmd/server/loadbalancer/Dockerfile
    ports: ["9080:80"]
    depends_on:
      consul-1:
        condition: service_healthy
    # --- MUDANÇA: Variável de ambiente explícita para a porta de escuta do LB ---
    environment:
      - CONSUL_ADDRS=consul-1:8500,consul-2:8500,consul-3:8500
      - LB_TARGET_SERVICE=jokenpo-session
      - LB_LISTEN_ADDR=:80
    profiles: [lb]

  load-balancer-2:
    build:
      context: .
      dockerfile: ./cmd/server/loadbalancer/Dockerfile
    ports: ["9081:80"]
    depends_on:
      consul-1:
        condition: service_healthy
    environment:
      - CONSUL_ADDRS=consul-1:8500,consul-2:8500,consul-3:8500
      - LB_TARGET_SERVICE=jokenpo-session
      - LB_LISTEN_ADDR=:80
    profiles: [lb]

  load-balancer-3:
    build:
      context: .
      dockerfile: ./cmd/server/loadbalancer/Dockerfile
    ports: ["9082:80"]
    depends_on:
      consul-1:
        condition: service_healthy
    environment:
      - CONSUL_ADDRS=consul-1:8500,consul-2:8500,consul-3:8500
      - LB_TARGET_SERVICE=jokenpo-session
      - LB_LISTEN_ADDR=:80
    profiles: [lb]